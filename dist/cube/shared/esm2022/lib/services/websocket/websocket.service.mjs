import { Injectable, Inject } from '@angular/core';
import * as Stomp from 'stompjs';
import * as SockJs from 'sockjs-client';
import { BehaviorSubject, Subject } from 'rxjs';
import { WEBSOCKET_ENDPOINTS } from '../../types/websocket.constants';
import * as i0 from "@angular/core";
import * as i1 from "../auth/auth.service";
import * as i2 from "keycloak-angular";
export class WebSocketService {
    constructor(authService, keycloak, config) {
        this.authService = authService;
        this.keycloak = keycloak;
        this.config = config;
        this.subscriptions = [];
        this.isConnected = false;
        this.writingUsers = {};
        this.newChatMessage = new Subject();
        this.newStatus = new Subject();
        this.othersWriting = new BehaviorSubject({});
    }
    getWebSocketUrl() {
        return `${this.config.baseUrl}${this.config.separator}${this.config.basePort}${WEBSOCKET_ENDPOINTS.BASE_ENDPOINT}`;
    }
    connect() {
        this.stompClient = Stomp.over(new SockJs(this.getWebSocketUrl()));
        this.stompClient.connect({}, () => {
            console.warn("CONNESSO A WEB SOCKET");
            this.authService.userKeycloakBehaviorSubject.subscribe({
                next: (user) => this.userData = user
            });
            this.isConnected = true;
            this.registerUser();
            this.privateSubscription();
            this.statusSubscription();
            this.writingSubscription();
        });
    }
    async disconnect() {
        this.disconnectUser();
        await this.stompClient?.disconnect(() => {
            this.subscriptions.forEach((sub) => sub.sub.unsubscribe());
        });
        this.isConnected = false;
    }
    registerUser() {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.REGISTER}.${this.keycloak.getKeycloakInstance().subject}`);
    }
    disconnectUser() {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.DISCONNECT);
    }
    sendToOne(trigger) {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.SEND_TO_ONE, {}, JSON.stringify(trigger));
    }
    amIWriting(idchat, isWriting) {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.AM_I_WRITING}.${idchat}.${isWriting}`);
    }
    sendToGroup(trigger) {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.SEND_TO_GROUP, {}, JSON.stringify(trigger));
    }
    readMessage(id) {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.READ_MESSAGE}.${id}`);
    }
    privateSubscription() {
        this.onSubscription("Private", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.PRIVATE_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (message) => {
            this.newChatMessage.next(message.body);
        }));
    }
    statusSubscription() {
        this.onSubscription("Status", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.STATUS_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (newUserStatus) => {
            this.newStatus.next(JSON.parse(newUserStatus.body));
        }));
    }
    writingSubscription() {
        this.onSubscription("Writing", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.IS_WRITING_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (writingDto) => {
            const w = JSON.parse(writingDto.body);
            if (w.isWriting && (!this.writingUsers[w.chatId] || !this.writingUsers[w.chatId].includes(w.userId))) {
                if (!this.writingUsers[w.chatId]) {
                    this.writingUsers[w.chatId] = [];
                }
                this.writingUsers[w.chatId].push(w.userId);
            }
            else if (!w.isWriting && this.writingUsers[w.chatId] && this.writingUsers[w.chatId].includes(w.userId)) {
                this.writingUsers[w.chatId].splice(this.writingUsers[w.chatId].indexOf(w.userId), 1);
                if (this.writingUsers[w.chatId].length == 0) {
                    delete this.writingUsers[w.chatId];
                }
            }
            this.othersWriting.next(this.writingUsers);
        }));
    }
    onSubscription(key, sub) {
        for (let i = 0; i < this.subscriptions.length; i++) {
            if (this.subscriptions[i].key == key) {
                this.subscriptions[i].sub.unsubscribe();
                this.subscriptions.splice(i, 1);
            }
        }
        this.subscriptions.push({ key: key, sub: sub });
    }
    checkMessageSubscription(idChat, callBack) {
        this.onSubscription("Check", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.CHECK_SUBSCRIPTION}.${idChat}.${this.keycloak.getKeycloakInstance().subject}`, callBack));
    }
    checkmessageUnsubscribe() {
        for (let i = 0; i < this.subscriptions.length; i++) {
            if (this.subscriptions[i].key == 'Check') {
                this.subscriptions[i].sub.unsubscribe();
                this.subscriptions.splice(i, 1);
            }
        }
    }
    ngOnDestroy() {
        this.disconnect();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, deps: [{ token: i1.AuthService }, { token: i2.KeycloakService }, { token: 'SHARED_CONFIG' }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.AuthService }, { type: i2.KeycloakService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: ['SHARED_CONFIG']
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jdWJlL3NoYXJlZC9zcmMvbGliL3NlcnZpY2VzL3dlYnNvY2tldC93ZWJzb2NrZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFXLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUs1RCxPQUFPLEtBQUssS0FBSyxNQUFNLFNBQVMsQ0FBQztBQUNqQyxPQUFPLEtBQUssTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsZUFBZSxFQUFDLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQzs7OztBQUt0RSxNQUFNLE9BQU8sZ0JBQWdCO0lBWXpCLFlBQ1ksV0FBd0IsRUFDeEIsUUFBeUIsRUFDQSxNQUFvQjtRQUY3QyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUNBLFdBQU0sR0FBTixNQUFNLENBQWM7UUFiakQsa0JBQWEsR0FBOEMsRUFBRSxDQUFDO1FBQ3RFLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBR1osaUJBQVksR0FBbUMsRUFBRSxDQUFDO1FBRTFELG1CQUFjLEdBQWdDLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ2hGLGNBQVMsR0FBdUMsSUFBSSxPQUFPLEVBQTZCLENBQUM7UUFDekYsa0JBQWEsR0FBb0QsSUFBSSxlQUFlLENBQWlDLEVBQUUsQ0FBQyxDQUFDO0lBTXJILENBQUM7SUFFRyxlQUFlO1FBQ25CLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxhQUFh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MkJBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsT25EZXN0cm95LEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4uL2F1dGgvYXV0aC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgS2V5Y2xvYWtTZXJ2aWNlIH0gZnJvbSAna2V5Y2xvYWstYW5ndWxhcic7XHJcbmltcG9ydCB7IEtleWNsb2FrUHJvZmlsZSB9IGZyb20gJ2tleWNsb2FrLWpzJztcclxuaW1wb3J0IHsgSXNXcml0aW5nRHRvLE1lc3NhZ2VUcmlnZ2VyRFRPLHByb3BlcnRpZXNEVE8gfSBmcm9tICcuLi8uLi90eXBlcy90eXBlcyc7XHJcbmltcG9ydCAqIGFzIFN0b21wIGZyb20gJ3N0b21wanMnO1xyXG5pbXBvcnQgKiBhcyBTb2NrSnMgZnJvbSAnc29ja2pzLWNsaWVudCc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCxTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFNoYXJlZENvbmZpZyB9IGZyb20gJy4uLy4uL3R5cGVzL3NoYXJlZC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBXRUJTT0NLRVRfRU5EUE9JTlRTIH0gZnJvbSAnLi4vLi4vdHlwZXMvd2Vic29ja2V0LmNvbnN0YW50cyc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldFNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gICAgc3RvbXBDbGllbnQ/OiBTdG9tcC5DbGllbnQ7XHJcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IHsga2V5OiBzdHJpbmcsc3ViOiBTdG9tcC5TdWJzY3JpcHRpb24gfVtdID0gW107XHJcbiAgICBpc0Nvbm5lY3RlZCA9IGZhbHNlO1xyXG4gICAgdXNlckRhdGE/OiBLZXljbG9ha1Byb2ZpbGU7XHJcblxyXG4gICAgcHJpdmF0ZSB3cml0aW5nVXNlcnM6IHsgW2lkQ2hhdDogc3RyaW5nXTogc3RyaW5nW10gfSA9IHt9O1xyXG5cclxuICAgIG5ld0NoYXRNZXNzYWdlOiBTdWJqZWN0PHN0cmluZyB8IHVuZGVmaW5lZD4gPSBuZXcgU3ViamVjdDxzdHJpbmcgfCB1bmRlZmluZWQ+KCk7XHJcbiAgICBuZXdTdGF0dXM6IFN1YmplY3Q8cHJvcGVydGllc0RUTyB8IHVuZGVmaW5lZD4gPSBuZXcgU3ViamVjdDxwcm9wZXJ0aWVzRFRPIHwgdW5kZWZpbmVkPigpO1xyXG4gICAgb3RoZXJzV3JpdGluZzogQmVoYXZpb3JTdWJqZWN0PHsgW2lkQ2hhdDogc3RyaW5nXTogc3RyaW5nW10gfT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHsgW2lkQ2hhdDogc3RyaW5nXTogc3RyaW5nW10gfT4oe30pO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUga2V5Y2xvYWs6IEtleWNsb2FrU2VydmljZSxcclxuICAgICAgICBASW5qZWN0KCdTSEFSRURfQ09ORklHJykgcHJpdmF0ZSBjb25maWc6IFNoYXJlZENvbmZpZ1xyXG4gICAgKSB7IH1cclxuXHJcbiAgICBwcml2YXRlIGdldFdlYlNvY2tldFVybCgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBgJHt0aGlzLmNvbmZpZy5iYXNlVXJsfSR7dGhpcy5jb25maWcuc2VwYXJhdG9yfSR7dGhpcy5jb25maWcuYmFzZVBvcnR9JHtXRUJTT0NLRVRfRU5EUE9JTlRTLkJBU0VfRU5EUE9JTlR9YDtcclxuICAgIH1cclxuXHJcbiAgICBjb25uZWN0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQgPSBTdG9tcC5vdmVyKG5ldyBTb2NrSnModGhpcy5nZXRXZWJTb2NrZXRVcmwoKSkpO1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQuY29ubmVjdCh7fSwoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcIkNPTk5FU1NPIEEgV0VCIFNPQ0tFVFwiKTtcclxuICAgICAgICAgICAgdGhpcy5hdXRoU2VydmljZS51c2VyS2V5Y2xvYWtCZWhhdmlvclN1YmplY3Quc3Vic2NyaWJlKHtcclxuICAgICAgICAgICAgICAgIG5leHQ6ICh1c2VyKSA9PiB0aGlzLnVzZXJEYXRhID0gdXNlclxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJVc2VyKCk7XHJcbiAgICAgICAgICAgIHRoaXMucHJpdmF0ZVN1YnNjcmlwdGlvbigpO1xyXG4gICAgICAgICAgICB0aGlzLnN0YXR1c1N1YnNjcmlwdGlvbigpO1xyXG4gICAgICAgICAgICB0aGlzLndyaXRpbmdTdWJzY3JpcHRpb24oKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBkaXNjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHRoaXMuZGlzY29ubmVjdFVzZXIoKTtcclxuICAgICAgICBhd2FpdCB0aGlzLnN0b21wQ2xpZW50Py5kaXNjb25uZWN0KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmZvckVhY2goKHN1YikgPT4gc3ViLnN1Yi51bnN1YnNjcmliZSgpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcmVnaXN0ZXJVc2VyKCkge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQ/LnNlbmQoXHJcbiAgICAgICAgICAgIGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuUkVHSVNURVJ9LiR7dGhpcy5rZXljbG9hay5nZXRLZXljbG9ha0luc3RhbmNlKCkuc3ViamVjdH1gXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBkaXNjb25uZWN0VXNlcigpIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50Py5zZW5kKFdFQlNPQ0tFVF9FTkRQT0lOVFMuRElTQ09OTkVDVCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VuZFRvT25lKHRyaWdnZXI6IE1lc3NhZ2VUcmlnZ2VyRFRPKSB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudD8uc2VuZChXRUJTT0NLRVRfRU5EUE9JTlRTLlNFTkRfVE9fT05FLHt9LEpTT04uc3RyaW5naWZ5KHRyaWdnZXIpKTtcclxuICAgIH1cclxuXHJcbiAgICBhbUlXcml0aW5nKGlkY2hhdDogbnVtYmVyLGlzV3JpdGluZzogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQ/LnNlbmQoYCR7V0VCU09DS0VUX0VORFBPSU5UUy5BTV9JX1dSSVRJTkd9LiR7aWRjaGF0fS4ke2lzV3JpdGluZ31gKTtcclxuICAgIH1cclxuXHJcbiAgICBzZW5kVG9Hcm91cCh0cmlnZ2VyOiBNZXNzYWdlVHJpZ2dlckRUTykge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQ/LnNlbmQoV0VCU09DS0VUX0VORFBPSU5UUy5TRU5EX1RPX0dST1VQLHt9LEpTT04uc3RyaW5naWZ5KHRyaWdnZXIpKTtcclxuICAgIH1cclxuXHJcbiAgICByZWFkTWVzc2FnZShpZDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudD8uc2VuZChgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLlJFQURfTUVTU0FHRX0uJHtpZH1gKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlU3Vic2NyaXB0aW9uKCkge1xyXG4gICAgICAgIHRoaXMub25TdWJzY3JpcHRpb24oXHJcbiAgICAgICAgICAgIFwiUHJpdmF0ZVwiLFxyXG4gICAgICAgICAgICB0aGlzLnN0b21wQ2xpZW50IS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICBgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLlBSSVZBVEVfU1VCU0NSSVBUSU9OfS4ke3RoaXMua2V5Y2xvYWsuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnN1YmplY3R9YCxcclxuICAgICAgICAgICAgICAgIChtZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXdDaGF0TWVzc2FnZS5uZXh0KG1lc3NhZ2UuYm9keSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXR1c1N1YnNjcmlwdGlvbigpIHtcclxuICAgICAgICB0aGlzLm9uU3Vic2NyaXB0aW9uKFxyXG4gICAgICAgICAgICBcIlN0YXR1c1wiLFxyXG4gICAgICAgICAgICB0aGlzLnN0b21wQ2xpZW50IS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICBgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLlNUQVRVU19TVUJTQ1JJUFRJT059LiR7dGhpcy5rZXljbG9hay5nZXRLZXljbG9ha0luc3RhbmNlKCkuc3ViamVjdH1gLFxyXG4gICAgICAgICAgICAgICAgKG5ld1VzZXJTdGF0dXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm5ld1N0YXR1cy5uZXh0KEpTT04ucGFyc2UobmV3VXNlclN0YXR1cy5ib2R5KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHdyaXRpbmdTdWJzY3JpcHRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5vblN1YnNjcmlwdGlvbihcclxuICAgICAgICAgICAgXCJXcml0aW5nXCIsXHJcbiAgICAgICAgICAgIHRoaXMuc3RvbXBDbGllbnQhLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuSVNfV1JJVElOR19TVUJTQ1JJUFRJT059LiR7dGhpcy5rZXljbG9hay5nZXRLZXljbG9ha0luc3RhbmNlKCkuc3ViamVjdH1gLFxyXG4gICAgICAgICAgICAgICAgKHdyaXRpbmdEdG8pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB3OiBJc1dyaXRpbmdEdG8gPSBKU09OLnBhcnNlKHdyaXRpbmdEdG8uYm9keSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3LmlzV3JpdGluZyAmJiAoIXRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXSB8fCAhdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdLmluY2x1ZGVzKHcudXNlcklkKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXS5wdXNoKHcudXNlcklkKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF3LmlzV3JpdGluZyAmJiB0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0gJiYgdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdLmluY2x1ZGVzKHcudXNlcklkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0uc3BsaWNlKHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXS5pbmRleE9mKHcudXNlcklkKSwxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXS5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdGhlcnNXcml0aW5nLm5leHQodGhpcy53cml0aW5nVXNlcnMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBvblN1YnNjcmlwdGlvbihrZXk6IHN0cmluZyxzdWI6IFN0b21wLlN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdWJzY3JpcHRpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnNbaV0ua2V5ID09IGtleSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zW2ldLnN1Yi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnNwbGljZShpLDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKHsga2V5OiBrZXksc3ViOiBzdWIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tNZXNzYWdlU3Vic2NyaXB0aW9uKGlkQ2hhdDogc3RyaW5nLGNhbGxCYWNrOiAoKG1lc3NhZ2U6IFN0b21wLk1lc3NhZ2UpID0+IGFueSkpIHtcclxuICAgICAgICB0aGlzLm9uU3Vic2NyaXB0aW9uKFxyXG4gICAgICAgICAgICBcIkNoZWNrXCIsXHJcbiAgICAgICAgICAgIHRoaXMuc3RvbXBDbGllbnQhLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuQ0hFQ0tfU1VCU0NSSVBUSU9OfS4ke2lkQ2hhdH0uJHt0aGlzLmtleWNsb2FrLmdldEtleWNsb2FrSW5zdGFuY2UoKS5zdWJqZWN0fWAsXHJcbiAgICAgICAgICAgICAgICBjYWxsQmFja1xyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjaGVja21lc3NhZ2VVbnN1YnNjcmliZSgpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3Vic2NyaXB0aW9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zW2ldLmtleSA9PSAnQ2hlY2snKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnNbaV0uc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuc3BsaWNlKGksMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XHJcbiAgICB9XHJcbn0iXX0=