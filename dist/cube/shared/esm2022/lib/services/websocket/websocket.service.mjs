import { Injectable, Inject } from '@angular/core';
import * as Stomp from 'stompjs';
import * as SockJs from 'sockjs-client';
import { BehaviorSubject, Subject } from 'rxjs';
import { WEBSOCKET_ENDPOINTS } from './websocket.constants';
import * as i0 from "@angular/core";
import * as i1 from "../auth/auth.service";
import * as i2 from "keycloak-angular";
export class WebSocketService {
    constructor(authService, keycloak, config) {
        this.authService = authService;
        this.keycloak = keycloak;
        this.config = config;
        this.subscriptions = [];
        this.isConnected = false;
        this.writingUsers = {};
        this.newChatMessage = new Subject();
        this.newStatus = new Subject();
        this.othersWriting = new BehaviorSubject({});
    }
    getWebSocketUrl() {
        return `${this.config.baseUrl}${this.config.separator}${this.config.basePort}${WEBSOCKET_ENDPOINTS.BASE_ENDPOINT}`;
    }
    connect() {
        this.stompClient = Stomp.over(new SockJs(this.getWebSocketUrl()));
        this.stompClient.connect({}, () => {
            console.warn("CONNESSO A WEB SOCKET");
            this.authService.userKeycloakBehaviorSubject.subscribe({
                next: (user) => this.userData = user
            });
            this.isConnected = true;
            this.registerUser();
            this.privateSubscription();
            this.statusSubscription();
            this.writingSubscription();
        });
    }
    async disconnect() {
        this.disconnectUser();
        await this.stompClient?.disconnect(() => {
            this.subscriptions.forEach((sub) => sub.sub.unsubscribe());
        });
        this.isConnected = false;
    }
    registerUser() {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.REGISTER}.${this.keycloak.getKeycloakInstance().subject}`);
    }
    disconnectUser() {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.DISCONNECT);
    }
    sendToOne(trigger) {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.SEND_TO_ONE, {}, JSON.stringify(trigger));
    }
    amIWriting(idchat, isWriting) {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.AM_I_WRITING}.${idchat}.${isWriting}`);
    }
    sendToGroup(trigger) {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.SEND_TO_GROUP, {}, JSON.stringify(trigger));
    }
    readMessage(id) {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.READ_MESSAGE}.${id}`);
    }
    privateSubscription() {
        this.onSubscription("Private", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.PRIVATE_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (message) => {
            this.newChatMessage.next(message.body);
        }));
    }
    statusSubscription() {
        this.onSubscription("Status", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.STATUS_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (newUserStatus) => {
            this.newStatus.next(JSON.parse(newUserStatus.body));
        }));
    }
    writingSubscription() {
        this.onSubscription("Writing", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.IS_WRITING_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (writingDto) => {
            const w = JSON.parse(writingDto.body);
            if (w.isWriting && (!this.writingUsers[w.chatId] || !this.writingUsers[w.chatId].includes(w.userId))) {
                if (!this.writingUsers[w.chatId]) {
                    this.writingUsers[w.chatId] = [];
                }
                this.writingUsers[w.chatId].push(w.userId);
            }
            else if (!w.isWriting && this.writingUsers[w.chatId] && this.writingUsers[w.chatId].includes(w.userId)) {
                this.writingUsers[w.chatId].splice(this.writingUsers[w.chatId].indexOf(w.userId), 1);
                if (this.writingUsers[w.chatId].length == 0) {
                    delete this.writingUsers[w.chatId];
                }
            }
            this.othersWriting.next(this.writingUsers);
        }));
    }
    onSubscription(key, sub) {
        for (let i = 0; i < this.subscriptions.length; i++) {
            if (this.subscriptions[i].key == key) {
                this.subscriptions[i].sub.unsubscribe();
                this.subscriptions.splice(i, 1);
            }
        }
        this.subscriptions.push({ key: key, sub: sub });
    }
    checkMessageSubscription(idChat, callBack) {
        this.onSubscription("Check", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.CHECK_SUBSCRIPTION}.${idChat}.${this.keycloak.getKeycloakInstance().subject}`, callBack));
    }
    checkmessageUnsubscribe() {
        for (let i = 0; i < this.subscriptions.length; i++) {
            if (this.subscriptions[i].key == 'Check') {
                this.subscriptions[i].sub.unsubscribe();
                this.subscriptions.splice(i, 1);
            }
        }
    }
    ngOnDestroy() {
        this.disconnect();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, deps: [{ token: i1.AuthService }, { token: i2.KeycloakService }, { token: 'SHARED_CONFIG' }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.AuthService }, { type: i2.KeycloakService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: ['SHARED_CONFIG']
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jdWJlL3NoYXJlZC9zcmMvbGliL3NlcnZpY2VzL3dlYnNvY2tldC93ZWJzb2NrZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFXLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUs1RCxPQUFPLEtBQUssS0FBSyxNQUFNLFNBQVMsQ0FBQztBQUNqQyxPQUFPLEtBQUssTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsZUFBZSxFQUFDLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUs1RCxNQUFNLE9BQU8sZ0JBQWdCO0lBWXpCLFlBQ1ksV0FBd0IsRUFDeEIsUUFBeUIsRUFDQSxNQUFvQjtRQUY3QyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUNBLFdBQU0sR0FBTixNQUFNLENBQWM7UUFiakQsa0JBQWEsR0FBOEMsRUFBRSxDQUFDO1FBQ3RFLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBR1osaUJBQVksR0FBbUMsRUFBRSxDQUFDO1FBRTFELG1CQUFjLEdBQWdDLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ2hGLGNBQVMsR0FBdUMsSUFBSSxPQUFPLEVBQTZCLENBQUM7UUFDekYsa0JBQWEsR0FBb0QsSUFBSSxlQUFlLENBQWlDLEVBQUUsQ0FBQyxDQUFDO0lBTXJILENBQUM7SUFFRyxlQUFlO1FBQ25CLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2SCxDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBQyxHQUFHLEVBQUU7WUFDN0IsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBQ3RDLElBQUksQ0FBQyxXQUFXLENBQUMsMkJBQTJCLENBQUMsU0FBUyxDQUFDO2dCQUNuRCxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSTthQUN2QyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztZQUN4QixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVU7UUFDWixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdEIsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDcEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBQzdCLENBQUM7SUFFRCxZQUFZO1FBQ1IsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQ2xCLEdBQUcsbUJBQW1CLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FDbkYsQ0FBQztJQUNOLENBQUM7SUFFRCxjQUFjO1FBQ1YsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUEwQjtRQUNoQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLEVBQUMsRUFBRSxFQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUN2RixDQUFDO0lBRUQsVUFBVSxDQUFDLE1BQWMsRUFBQyxTQUFrQjtRQUN4QyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLG1CQUFtQixDQUFDLFlBQVksSUFBSSxNQUFNLElBQUksU0FBUyxFQUFFLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQTBCO1FBQ2xDLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsRUFBQyxFQUFFLEVBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRCxXQUFXLENBQUMsRUFBVTtRQUNsQixJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLG1CQUFtQixDQUFDLFlBQVksSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFFRCxtQkFBbUI7UUFDZixJQUFJLENBQUMsY0FBYyxDQUNmLFNBQVMsRUFDVCxJQUFJLENBQUMsV0FBWSxDQUFDLFNBQVMsQ0FDdkIsR0FBRyxtQkFBbUIsQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLENBQUMsT0FBTyxFQUFFLEVBQzVGLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDUixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUNKLENBQ0osQ0FBQztJQUNOLENBQUM7SUFFRCxrQkFBa0I7UUFDZCxJQUFJLENBQUMsY0FBYyxDQUNmLFFBQVEsRUFDUixJQUFJLENBQUMsV0FBWSxDQUFDLFNBQVMsQ0FDdkIsR0FBRyxtQkFBbUIsQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLENBQUMsT0FBTyxFQUFFLEVBQzNGLENBQUMsYUFBYSxFQUFFLEVBQUU7WUFDZCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3hELENBQUMsQ0FDSixDQUNKLENBQUM7SUFDTixDQUFDO0lBRUQsbUJBQW1CO1FBQ2YsSUFBSSxDQUFDLGNBQWMsQ0FDZixTQUFTLEVBQ1QsSUFBSSxDQUFDLFdBQVksQ0FBQyxTQUFTLENBQ3ZCLEdBQUcsbUJBQW1CLENBQUMsdUJBQXVCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUMvRixDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQ1gsTUFBTSxDQUFDLEdBQWlCLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRXBELElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUU7Z0JBQ2xHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDOUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO2lCQUNwQztnQkFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQzlDO2lCQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3RHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwRixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7b0JBQ3pDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ3RDO2FBQ0o7WUFFRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0MsQ0FBQyxDQUNKLENBQ0osQ0FBQztJQUNOLENBQUM7SUFFRCxjQUFjLENBQUMsR0FBVyxFQUFDLEdBQXVCO1FBQzlDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNoRCxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsRUFBRTtnQkFDbEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQzthQUNsQztTQUNKO1FBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRCx3QkFBd0IsQ0FBQyxNQUFjLEVBQUMsUUFBMkM7UUFDL0UsSUFBSSxDQUFDLGNBQWMsQ0FDZixPQUFPLEVBQ1AsSUFBSSxDQUFDLFdBQVksQ0FBQyxTQUFTLENBQ3ZCLEdBQUcsbUJBQW1CLENBQUMsa0JBQWtCLElBQUksTUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFDcEcsUUFBUSxDQUNYLENBQ0osQ0FBQztJQUNOLENBQUM7SUFFRCx1QkFBdUI7UUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ2hELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksT0FBTyxFQUFFO2dCQUN0QyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2xDO1NBQ0o7SUFDTCxDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUN0QixDQUFDOytHQXhKUSxnQkFBZ0IsNEVBZWIsZUFBZTttSEFmbEIsZ0JBQWdCLGNBRmIsTUFBTTs7NEZBRVQsZ0JBQWdCO2tCQUg1QixVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQjs7MEJBZ0JRLE1BQU07MkJBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsT25EZXN0cm95LEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4uL2F1dGgvYXV0aC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgS2V5Y2xvYWtTZXJ2aWNlIH0gZnJvbSAna2V5Y2xvYWstYW5ndWxhcic7XHJcbmltcG9ydCB7IEtleWNsb2FrUHJvZmlsZSB9IGZyb20gJ2tleWNsb2FrLWpzJztcclxuaW1wb3J0IHsgSXNXcml0aW5nRHRvLE1lc3NhZ2VUcmlnZ2VyRFRPLHByb3BlcnRpZXNEVE8gfSBmcm9tICcuLi8uLi90eXBlcy90eXBlcyc7XHJcbmltcG9ydCAqIGFzIFN0b21wIGZyb20gJ3N0b21wanMnO1xyXG5pbXBvcnQgKiBhcyBTb2NrSnMgZnJvbSAnc29ja2pzLWNsaWVudCc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCxTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFNoYXJlZENvbmZpZyB9IGZyb20gJy4uLy4uL3NoYXJlZC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBXRUJTT0NLRVRfRU5EUE9JTlRTIH0gZnJvbSAnLi93ZWJzb2NrZXQuY29uc3RhbnRzJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgV2ViU29ja2V0U2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XHJcbiAgICBzdG9tcENsaWVudD86IFN0b21wLkNsaWVudDtcclxuICAgIHByaXZhdGUgc3Vic2NyaXB0aW9uczogeyBrZXk6IHN0cmluZyxzdWI6IFN0b21wLlN1YnNjcmlwdGlvbiB9W10gPSBbXTtcclxuICAgIGlzQ29ubmVjdGVkID0gZmFsc2U7XHJcbiAgICB1c2VyRGF0YT86IEtleWNsb2FrUHJvZmlsZTtcclxuXHJcbiAgICBwcml2YXRlIHdyaXRpbmdVc2VyczogeyBbaWRDaGF0OiBzdHJpbmddOiBzdHJpbmdbXSB9ID0ge307XHJcblxyXG4gICAgbmV3Q2hhdE1lc3NhZ2U6IFN1YmplY3Q8c3RyaW5nIHwgdW5kZWZpbmVkPiA9IG5ldyBTdWJqZWN0PHN0cmluZyB8IHVuZGVmaW5lZD4oKTtcclxuICAgIG5ld1N0YXR1czogU3ViamVjdDxwcm9wZXJ0aWVzRFRPIHwgdW5kZWZpbmVkPiA9IG5ldyBTdWJqZWN0PHByb3BlcnRpZXNEVE8gfCB1bmRlZmluZWQ+KCk7XHJcbiAgICBvdGhlcnNXcml0aW5nOiBCZWhhdmlvclN1YmplY3Q8eyBbaWRDaGF0OiBzdHJpbmddOiBzdHJpbmdbXSB9PiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8eyBbaWRDaGF0OiBzdHJpbmddOiBzdHJpbmdbXSB9Pih7fSk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBrZXljbG9hazogS2V5Y2xvYWtTZXJ2aWNlLFxyXG4gICAgICAgIEBJbmplY3QoJ1NIQVJFRF9DT05GSUcnKSBwcml2YXRlIGNvbmZpZzogU2hhcmVkQ29uZmlnXHJcbiAgICApIHsgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0V2ViU29ja2V0VXJsKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuY29uZmlnLmJhc2VVcmx9JHt0aGlzLmNvbmZpZy5zZXBhcmF0b3J9JHt0aGlzLmNvbmZpZy5iYXNlUG9ydH0ke1dFQlNPQ0tFVF9FTkRQT0lOVFMuQkFTRV9FTkRQT0lOVH1gO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbm5lY3QoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudCA9IFN0b21wLm92ZXIobmV3IFNvY2tKcyh0aGlzLmdldFdlYlNvY2tldFVybCgpKSk7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudC5jb25uZWN0KHt9LCgpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiQ09OTkVTU08gQSBXRUIgU09DS0VUXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlLnVzZXJLZXljbG9ha0JlaGF2aW9yU3ViamVjdC5zdWJzY3JpYmUoe1xyXG4gICAgICAgICAgICAgICAgbmV4dDogKHVzZXIpID0+IHRoaXMudXNlckRhdGEgPSB1c2VyXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5yZWdpc3RlclVzZXIoKTtcclxuICAgICAgICAgICAgdGhpcy5wcml2YXRlU3Vic2NyaXB0aW9uKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzU3Vic2NyaXB0aW9uKCk7XHJcbiAgICAgICAgICAgIHRoaXMud3JpdGluZ1N1YnNjcmlwdGlvbigpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGRpc2Nvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0VXNlcigpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuc3RvbXBDbGllbnQ/LmRpc2Nvbm5lY3QoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaCgoc3ViKSA9PiBzdWIuc3ViLnVuc3Vic2NyaWJlKCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICByZWdpc3RlclVzZXIoKSB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudD8uc2VuZChcclxuICAgICAgICAgICAgYCR7V0VCU09DS0VUX0VORFBPSU5UUy5SRUdJU1RFUn0uJHt0aGlzLmtleWNsb2FrLmdldEtleWNsb2FrSW5zdGFuY2UoKS5zdWJqZWN0fWBcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGRpc2Nvbm5lY3RVc2VyKCkge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQ/LnNlbmQoV0VCU09DS0VUX0VORFBPSU5UUy5ESVNDT05ORUNUKTtcclxuICAgIH1cclxuXHJcbiAgICBzZW5kVG9PbmUodHJpZ2dlcjogTWVzc2FnZVRyaWdnZXJEVE8pIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50Py5zZW5kKFdFQlNPQ0tFVF9FTkRQT0lOVFMuU0VORF9UT19PTkUse30sSlNPTi5zdHJpbmdpZnkodHJpZ2dlcikpO1xyXG4gICAgfVxyXG5cclxuICAgIGFtSVdyaXRpbmcoaWRjaGF0OiBudW1iZXIsaXNXcml0aW5nOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudD8uc2VuZChgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLkFNX0lfV1JJVElOR30uJHtpZGNoYXR9LiR7aXNXcml0aW5nfWApO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmRUb0dyb3VwKHRyaWdnZXI6IE1lc3NhZ2VUcmlnZ2VyRFRPKSB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudD8uc2VuZChXRUJTT0NLRVRfRU5EUE9JTlRTLlNFTkRfVE9fR1JPVVAse30sSlNPTi5zdHJpbmdpZnkodHJpZ2dlcikpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlYWRNZXNzYWdlKGlkOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50Py5zZW5kKGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuUkVBRF9NRVNTQUdFfS4ke2lkfWApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGVTdWJzY3JpcHRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5vblN1YnNjcmlwdGlvbihcclxuICAgICAgICAgICAgXCJQcml2YXRlXCIsXHJcbiAgICAgICAgICAgIHRoaXMuc3RvbXBDbGllbnQhLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuUFJJVkFURV9TVUJTQ1JJUFRJT059LiR7dGhpcy5rZXljbG9hay5nZXRLZXljbG9ha0luc3RhbmNlKCkuc3ViamVjdH1gLFxyXG4gICAgICAgICAgICAgICAgKG1lc3NhZ2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm5ld0NoYXRNZXNzYWdlLm5leHQobWVzc2FnZS5ib2R5KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdHVzU3Vic2NyaXB0aW9uKCkge1xyXG4gICAgICAgIHRoaXMub25TdWJzY3JpcHRpb24oXHJcbiAgICAgICAgICAgIFwiU3RhdHVzXCIsXHJcbiAgICAgICAgICAgIHRoaXMuc3RvbXBDbGllbnQhLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuU1RBVFVTX1NVQlNDUklQVElPTn0uJHt0aGlzLmtleWNsb2FrLmdldEtleWNsb2FrSW5zdGFuY2UoKS5zdWJqZWN0fWAsXHJcbiAgICAgICAgICAgICAgICAobmV3VXNlclN0YXR1cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmV3U3RhdHVzLm5leHQoSlNPTi5wYXJzZShuZXdVc2VyU3RhdHVzLmJvZHkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgd3JpdGluZ1N1YnNjcmlwdGlvbigpIHtcclxuICAgICAgICB0aGlzLm9uU3Vic2NyaXB0aW9uKFxyXG4gICAgICAgICAgICBcIldyaXRpbmdcIixcclxuICAgICAgICAgICAgdGhpcy5zdG9tcENsaWVudCEuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgYCR7V0VCU09DS0VUX0VORFBPSU5UUy5JU19XUklUSU5HX1NVQlNDUklQVElPTn0uJHt0aGlzLmtleWNsb2FrLmdldEtleWNsb2FrSW5zdGFuY2UoKS5zdWJqZWN0fWAsXHJcbiAgICAgICAgICAgICAgICAod3JpdGluZ0R0bykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHc6IElzV3JpdGluZ0R0byA9IEpTT04ucGFyc2Uod3JpdGluZ0R0by5ib2R5KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHcuaXNXcml0aW5nICYmICghdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdIHx8ICF0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0uaW5jbHVkZXMody51c2VySWQpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdLnB1c2gody51c2VySWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXcuaXNXcml0aW5nICYmIHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXSAmJiB0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0uaW5jbHVkZXMody51c2VySWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXS5zcGxpY2UodGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdLmluZGV4T2Yody51c2VySWQpLDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdLmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm90aGVyc1dyaXRpbmcubmV4dCh0aGlzLndyaXRpbmdVc2Vycyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU3Vic2NyaXB0aW9uKGtleTogc3RyaW5nLHN1YjogU3RvbXAuU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uc1tpXS5rZXkgPT0ga2V5KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnNbaV0uc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuc3BsaWNlKGksMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2goeyBrZXk6IGtleSxzdWI6IHN1YiB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjaGVja01lc3NhZ2VTdWJzY3JpcHRpb24oaWRDaGF0OiBzdHJpbmcsY2FsbEJhY2s6ICgobWVzc2FnZTogU3RvbXAuTWVzc2FnZSkgPT4gYW55KSkge1xyXG4gICAgICAgIHRoaXMub25TdWJzY3JpcHRpb24oXHJcbiAgICAgICAgICAgIFwiQ2hlY2tcIixcclxuICAgICAgICAgICAgdGhpcy5zdG9tcENsaWVudCEuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgYCR7V0VCU09DS0VUX0VORFBPSU5UUy5DSEVDS19TVUJTQ1JJUFRJT059LiR7aWRDaGF0fS4ke3RoaXMua2V5Y2xvYWsuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnN1YmplY3R9YCxcclxuICAgICAgICAgICAgICAgIGNhbGxCYWNrXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrbWVzc2FnZVVuc3Vic2NyaWJlKCkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdWJzY3JpcHRpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnNbaV0ua2V5ID09ICdDaGVjaycpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc1tpXS5zdWIudW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5zcGxpY2UoaSwxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTtcclxuICAgIH1cclxufSJdfQ==