import { Injectable, Inject } from '@angular/core';
import * as Stomp from 'stompjs';
import * as SockJs from 'sockjs-client';
import { BehaviorSubject, Subject } from 'rxjs';
import { WEBSOCKET_ENDPOINTS } from '../../types/websocket.constants';
import * as i0 from "@angular/core";
import * as i1 from "../auth/auth.service";
import * as i2 from "keycloak-angular";
export class WebSocketService {
    constructor(authService, keycloak, config) {
        this.authService = authService;
        this.keycloak = keycloak;
        this.config = config;
        this.subscriptions = [];
        this.isConnected = false;
        this.writingUsers = {};
        this.newChatMessage = new Subject();
        this.newStatus = new Subject();
        this.othersWriting = new BehaviorSubject({});
        this.newNotification = new Subject();
    }
    getWebSocketUrl() {
        return `${this.config.baseUrl}${this.config.separator}${this.config.basePort}${WEBSOCKET_ENDPOINTS.BASE_ENDPOINT}`;
    }
    connect() {
        this.stompClient = Stomp.over(new SockJs(this.getWebSocketUrl()));
        this.stompClient.connect({}, () => {
            console.warn("CONNESSO A WEB SOCKET");
            this.authService.userKeycloakBehaviorSubject.subscribe({
                next: (user) => this.userData = user
            });
            this.isConnected = true;
            this.registerUser();
            this.privateSubscription();
            this.statusSubscription();
            this.writingSubscription();
            this.notificationSubscription();
        });
    }
    async disconnect() {
        this.disconnectUser();
        await this.stompClient?.disconnect(() => {
            this.subscriptions.forEach((sub) => sub.sub.unsubscribe());
        });
        this.isConnected = false;
    }
    registerUser() {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.REGISTER}.${this.keycloak.getKeycloakInstance().subject}`);
    }
    disconnectUser() {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.DISCONNECT);
    }
    sendToOne(trigger) {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.SEND_TO_ONE, {}, JSON.stringify(trigger));
    }
    amIWriting(idchat, isWriting) {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.AM_I_WRITING}.${idchat}.${isWriting}`);
    }
    sendToGroup(trigger) {
        this.stompClient?.send(WEBSOCKET_ENDPOINTS.SEND_TO_GROUP, {}, JSON.stringify(trigger));
    }
    readMessage(id) {
        this.stompClient?.send(`${WEBSOCKET_ENDPOINTS.READ_MESSAGE}.${id}`);
    }
    privateSubscription() {
        this.onSubscription("Private", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.PRIVATE_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (message) => {
            this.newChatMessage.next(message.body);
        }));
    }
    statusSubscription() {
        this.onSubscription("Status", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.STATUS_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (newUserStatus) => {
            this.newStatus.next(JSON.parse(newUserStatus.body));
        }));
    }
    notificationSubscription() {
        this.onSubscription("Notification", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.NOTIFICATION_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, () => {
            this.newNotification.next(true);
        }));
    }
    writingSubscription() {
        this.onSubscription("Writing", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.IS_WRITING_SUBSCRIPTION}.${this.keycloak.getKeycloakInstance().subject}`, (writingDto) => {
            const w = JSON.parse(writingDto.body);
            if (w.isWriting && (!this.writingUsers[w.chatId] || !this.writingUsers[w.chatId].includes(w.userId))) {
                if (!this.writingUsers[w.chatId]) {
                    this.writingUsers[w.chatId] = [];
                }
                this.writingUsers[w.chatId].push(w.userId);
            }
            else if (!w.isWriting && this.writingUsers[w.chatId] && this.writingUsers[w.chatId].includes(w.userId)) {
                this.writingUsers[w.chatId].splice(this.writingUsers[w.chatId].indexOf(w.userId), 1);
                if (this.writingUsers[w.chatId].length == 0) {
                    delete this.writingUsers[w.chatId];
                }
            }
            this.othersWriting.next(this.writingUsers);
        }));
    }
    onSubscription(key, sub) {
        for (let i = 0; i < this.subscriptions.length; i++) {
            if (this.subscriptions[i].key == key) {
                this.subscriptions[i].sub.unsubscribe();
                this.subscriptions.splice(i, 1);
            }
        }
        this.subscriptions.push({ key: key, sub: sub });
    }
    checkMessageSubscription(idChat, callBack) {
        this.onSubscription("Check", this.stompClient.subscribe(`${WEBSOCKET_ENDPOINTS.CHECK_SUBSCRIPTION}.${idChat}.${this.keycloak.getKeycloakInstance().subject}`, callBack));
    }
    checkmessageUnsubscribe() {
        for (let i = 0; i < this.subscriptions.length; i++) {
            if (this.subscriptions[i].key == 'Check') {
                this.subscriptions[i].sub.unsubscribe();
                this.subscriptions.splice(i, 1);
            }
        }
    }
    ngOnDestroy() {
        this.disconnect();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, deps: [{ token: i1.AuthService }, { token: i2.KeycloakService }, { token: 'SHARED_CONFIG' }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: WebSocketService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.AuthService }, { type: i2.KeycloakService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: ['SHARED_CONFIG']
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jdWJlL3NoYXJlZC9zcmMvbGliL3NlcnZpY2VzL3dlYnNvY2tldC93ZWJzb2NrZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFXLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUs1RCxPQUFPLEtBQUssS0FBSyxNQUFNLFNBQVMsQ0FBQztBQUNqQyxPQUFPLEtBQUssTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsZUFBZSxFQUFDLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQzs7OztBQUt0RSxNQUFNLE9BQU8sZ0JBQWdCO0lBYXpCLFlBQ1ksV0FBd0IsRUFDeEIsUUFBeUIsRUFDQSxNQUFvQjtRQUY3QyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUNBLFdBQU0sR0FBTixNQUFNLENBQWM7UUFkakQsa0JBQWEsR0FBOEMsRUFBRSxDQUFDO1FBQ3RFLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBR1osaUJBQVksR0FBbUMsRUFBRSxDQUFDO1FBRTFELG1CQUFjLEdBQWdDLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ2hGLGNBQVMsR0FBdUMsSUFBSSxPQUFPLEVBQTZCLENBQUM7UUFDekYsa0JBQWEsR0FBb0QsSUFBSSxlQUFlLENBQWlDLEVBQUUsQ0FBQyxDQUFDO1FBQ3pILG9CQUFlLEdBQXFCLElBQUksT0FBTyxFQUFXLENBQUM7SUFNdkQsQ0FBQztJQUVHLGVBQWU7UUFDbkIsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksQ0FB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RUFBRTtnQkFDdEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQzthQUNsQztTQUNKO0lBQ0wsQ0FBQztJQUVELFdBQVc7UUFDUCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDdEIsQ0FBQzsrR0F0S1EsZ0JBQWdCLDRFQWdCYixlQUFlO21IQWhCbEIsZ0JBQWdCLGNBRmIsTUFBTTs7NEZBRVQsZ0JBQWdCO2tCQUg1QixVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQjs7MEJBaUJRLE1BQU07MkJBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsT25EZXN0cm95LEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4uL2F1dGgvYXV0aC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgS2V5Y2xvYWtTZXJ2aWNlIH0gZnJvbSAna2V5Y2xvYWstYW5ndWxhcic7XHJcbmltcG9ydCB7IEtleWNsb2FrUHJvZmlsZSB9IGZyb20gJ2tleWNsb2FrLWpzJztcclxuaW1wb3J0IHsgSXNXcml0aW5nRHRvLE1lc3NhZ2VUcmlnZ2VyRFRPLHByb3BlcnRpZXNEVE8gfSBmcm9tICcuLi8uLi90eXBlcy90eXBlcyc7XHJcbmltcG9ydCAqIGFzIFN0b21wIGZyb20gJ3N0b21wanMnO1xyXG5pbXBvcnQgKiBhcyBTb2NrSnMgZnJvbSAnc29ja2pzLWNsaWVudCc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCxTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFNoYXJlZENvbmZpZyB9IGZyb20gJy4uLy4uL3R5cGVzL3NoYXJlZC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBXRUJTT0NLRVRfRU5EUE9JTlRTIH0gZnJvbSAnLi4vLi4vdHlwZXMvd2Vic29ja2V0LmNvbnN0YW50cyc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldFNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gICAgc3RvbXBDbGllbnQ/OiBTdG9tcC5DbGllbnQ7XHJcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IHsga2V5OiBzdHJpbmcsc3ViOiBTdG9tcC5TdWJzY3JpcHRpb24gfVtdID0gW107XHJcbiAgICBpc0Nvbm5lY3RlZCA9IGZhbHNlO1xyXG4gICAgdXNlckRhdGE/OiBLZXljbG9ha1Byb2ZpbGU7XHJcblxyXG4gICAgcHJpdmF0ZSB3cml0aW5nVXNlcnM6IHsgW2lkQ2hhdDogc3RyaW5nXTogc3RyaW5nW10gfSA9IHt9O1xyXG5cclxuICAgIG5ld0NoYXRNZXNzYWdlOiBTdWJqZWN0PHN0cmluZyB8IHVuZGVmaW5lZD4gPSBuZXcgU3ViamVjdDxzdHJpbmcgfCB1bmRlZmluZWQ+KCk7XHJcbiAgICBuZXdTdGF0dXM6IFN1YmplY3Q8cHJvcGVydGllc0RUTyB8IHVuZGVmaW5lZD4gPSBuZXcgU3ViamVjdDxwcm9wZXJ0aWVzRFRPIHwgdW5kZWZpbmVkPigpO1xyXG4gICAgb3RoZXJzV3JpdGluZzogQmVoYXZpb3JTdWJqZWN0PHsgW2lkQ2hhdDogc3RyaW5nXTogc3RyaW5nW10gfT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHsgW2lkQ2hhdDogc3RyaW5nXTogc3RyaW5nW10gfT4oe30pO1xyXG4gICAgbmV3Tm90aWZpY2F0aW9uOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGtleWNsb2FrOiBLZXljbG9ha1NlcnZpY2UsXHJcbiAgICAgICAgQEluamVjdCgnU0hBUkVEX0NPTkZJRycpIHByaXZhdGUgY29uZmlnOiBTaGFyZWRDb25maWdcclxuICAgICkgeyB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRXZWJTb2NrZXRVcmwoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gYCR7dGhpcy5jb25maWcuYmFzZVVybH0ke3RoaXMuY29uZmlnLnNlcGFyYXRvcn0ke3RoaXMuY29uZmlnLmJhc2VQb3J0fSR7V0VCU09DS0VUX0VORFBPSU5UUy5CQVNFX0VORFBPSU5UfWA7XHJcbiAgICB9XHJcblxyXG4gICAgY29ubmVjdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50ID0gU3RvbXAub3ZlcihuZXcgU29ja0pzKHRoaXMuZ2V0V2ViU29ja2V0VXJsKCkpKTtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50LmNvbm5lY3Qoe30sKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJDT05ORVNTTyBBIFdFQiBTT0NLRVRcIik7XHJcbiAgICAgICAgICAgIHRoaXMuYXV0aFNlcnZpY2UudXNlcktleWNsb2FrQmVoYXZpb3JTdWJqZWN0LnN1YnNjcmliZSh7XHJcbiAgICAgICAgICAgICAgICBuZXh0OiAodXNlcikgPT4gdGhpcy51c2VyRGF0YSA9IHVzZXJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVyVXNlcigpO1xyXG4gICAgICAgICAgICB0aGlzLnByaXZhdGVTdWJzY3JpcHRpb24oKTtcclxuICAgICAgICAgICAgdGhpcy5zdGF0dXNTdWJzY3JpcHRpb24oKTtcclxuICAgICAgICAgICAgdGhpcy53cml0aW5nU3Vic2NyaXB0aW9uKCk7XHJcbiAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU3Vic2NyaXB0aW9uKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZGlzY29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICB0aGlzLmRpc2Nvbm5lY3RVc2VyKCk7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5zdG9tcENsaWVudD8uZGlzY29ubmVjdCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKChzdWIpID0+IHN1Yi5zdWIudW5zdWJzY3JpYmUoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyVXNlcigpIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50Py5zZW5kKFxyXG4gICAgICAgICAgICBgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLlJFR0lTVEVSfS4ke3RoaXMua2V5Y2xvYWsuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnN1YmplY3R9YFxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgZGlzY29ubmVjdFVzZXIoKSB7XHJcbiAgICAgICAgdGhpcy5zdG9tcENsaWVudD8uc2VuZChXRUJTT0NLRVRfRU5EUE9JTlRTLkRJU0NPTk5FQ1QpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmRUb09uZSh0cmlnZ2VyOiBNZXNzYWdlVHJpZ2dlckRUTykge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQ/LnNlbmQoV0VCU09DS0VUX0VORFBPSU5UUy5TRU5EX1RPX09ORSx7fSxKU09OLnN0cmluZ2lmeSh0cmlnZ2VyKSk7XHJcbiAgICB9XHJcblxyXG4gICAgYW1JV3JpdGluZyhpZGNoYXQ6IG51bWJlcixpc1dyaXRpbmc6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50Py5zZW5kKGAke1dFQlNPQ0tFVF9FTkRQT0lOVFMuQU1fSV9XUklUSU5HfS4ke2lkY2hhdH0uJHtpc1dyaXRpbmd9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VuZFRvR3JvdXAodHJpZ2dlcjogTWVzc2FnZVRyaWdnZXJEVE8pIHtcclxuICAgICAgICB0aGlzLnN0b21wQ2xpZW50Py5zZW5kKFdFQlNPQ0tFVF9FTkRQT0lOVFMuU0VORF9UT19HUk9VUCx7fSxKU09OLnN0cmluZ2lmeSh0cmlnZ2VyKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVhZE1lc3NhZ2UoaWQ6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuc3RvbXBDbGllbnQ/LnNlbmQoYCR7V0VCU09DS0VUX0VORFBPSU5UUy5SRUFEX01FU1NBR0V9LiR7aWR9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZVN1YnNjcmlwdGlvbigpIHtcclxuICAgICAgICB0aGlzLm9uU3Vic2NyaXB0aW9uKFxyXG4gICAgICAgICAgICBcIlByaXZhdGVcIixcclxuICAgICAgICAgICAgdGhpcy5zdG9tcENsaWVudCEuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgYCR7V0VCU09DS0VUX0VORFBPSU5UUy5QUklWQVRFX1NVQlNDUklQVElPTn0uJHt0aGlzLmtleWNsb2FrLmdldEtleWNsb2FrSW5zdGFuY2UoKS5zdWJqZWN0fWAsXHJcbiAgICAgICAgICAgICAgICAobWVzc2FnZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmV3Q2hhdE1lc3NhZ2UubmV4dChtZXNzYWdlLmJvZHkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0dXNTdWJzY3JpcHRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5vblN1YnNjcmlwdGlvbihcclxuICAgICAgICAgICAgXCJTdGF0dXNcIixcclxuICAgICAgICAgICAgdGhpcy5zdG9tcENsaWVudCEuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgYCR7V0VCU09DS0VUX0VORFBPSU5UUy5TVEFUVVNfU1VCU0NSSVBUSU9OfS4ke3RoaXMua2V5Y2xvYWsuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnN1YmplY3R9YCxcclxuICAgICAgICAgICAgICAgIChuZXdVc2VyU3RhdHVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXdTdGF0dXMubmV4dChKU09OLnBhcnNlKG5ld1VzZXJTdGF0dXMuYm9keSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBub3RpZmljYXRpb25TdWJzY3JpcHRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5vblN1YnNjcmlwdGlvbihcclxuICAgICAgICAgICAgXCJOb3RpZmljYXRpb25cIixcclxuICAgICAgICAgICAgdGhpcy5zdG9tcENsaWVudCEuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgYCR7V0VCU09DS0VUX0VORFBPSU5UUy5OT1RJRklDQVRJT05fU1VCU0NSSVBUSU9OfS4ke3RoaXMua2V5Y2xvYWsuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnN1YmplY3R9YCxcclxuICAgICAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm5ld05vdGlmaWNhdGlvbi5uZXh0KHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICB3cml0aW5nU3Vic2NyaXB0aW9uKCkge1xyXG4gICAgICAgIHRoaXMub25TdWJzY3JpcHRpb24oXHJcbiAgICAgICAgICAgIFwiV3JpdGluZ1wiLFxyXG4gICAgICAgICAgICB0aGlzLnN0b21wQ2xpZW50IS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICBgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLklTX1dSSVRJTkdfU1VCU0NSSVBUSU9OfS4ke3RoaXMua2V5Y2xvYWsuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnN1YmplY3R9YCxcclxuICAgICAgICAgICAgICAgICh3cml0aW5nRHRvKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdzogSXNXcml0aW5nRHRvID0gSlNPTi5wYXJzZSh3cml0aW5nRHRvLmJvZHkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAody5pc1dyaXRpbmcgJiYgKCF0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0gfHwgIXRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXS5pbmNsdWRlcyh3LnVzZXJJZCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0ucHVzaCh3LnVzZXJJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdy5pc1dyaXRpbmcgJiYgdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdICYmIHRoaXMud3JpdGluZ1VzZXJzW3cuY2hhdElkXS5pbmNsdWRlcyh3LnVzZXJJZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53cml0aW5nVXNlcnNbdy5jaGF0SWRdLnNwbGljZSh0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0uaW5kZXhPZih3LnVzZXJJZCksMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF0ubGVuZ3RoID09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndyaXRpbmdVc2Vyc1t3LmNoYXRJZF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3RoZXJzV3JpdGluZy5uZXh0KHRoaXMud3JpdGluZ1VzZXJzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgb25TdWJzY3JpcHRpb24oa2V5OiBzdHJpbmcsc3ViOiBTdG9tcC5TdWJzY3JpcHRpb24pIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3Vic2NyaXB0aW9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zW2ldLmtleSA9PSBrZXkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc1tpXS5zdWIudW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5zcGxpY2UoaSwxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaCh7IGtleToga2V5LHN1Yjogc3ViIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrTWVzc2FnZVN1YnNjcmlwdGlvbihpZENoYXQ6IHN0cmluZyxjYWxsQmFjazogKChtZXNzYWdlOiBTdG9tcC5NZXNzYWdlKSA9PiBhbnkpKSB7XHJcbiAgICAgICAgdGhpcy5vblN1YnNjcmlwdGlvbihcclxuICAgICAgICAgICAgXCJDaGVja1wiLFxyXG4gICAgICAgICAgICB0aGlzLnN0b21wQ2xpZW50IS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICBgJHtXRUJTT0NLRVRfRU5EUE9JTlRTLkNIRUNLX1NVQlNDUklQVElPTn0uJHtpZENoYXR9LiR7dGhpcy5rZXljbG9hay5nZXRLZXljbG9ha0luc3RhbmNlKCkuc3ViamVjdH1gLFxyXG4gICAgICAgICAgICAgICAgY2FsbEJhY2tcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2ttZXNzYWdlVW5zdWJzY3JpYmUoKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uc1tpXS5rZXkgPT0gJ0NoZWNrJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zW2ldLnN1Yi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnNwbGljZShpLDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xyXG4gICAgfVxyXG59Il19